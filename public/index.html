<!DOCTYPE html>
<html lang="en">
<head>
<title>Angular Issues</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="build/build.css">
<link rel="stylesheet" href="css/site.css">
<script src="build/build.js"></script>
<script src="js/markdown.js"></script>
<script type="text/javascript">
var startDate = new Date(Date.now()-1000*60*60*24*7);
var pages = [ ];
var current_page = 1;
var pagecount = 0;
function render(response) {
	var meta = response.meta;
	var data = response.data;
	var header_template = $('#header_template').html();
	var issue_template = $('#issue_template').html();
	Mustache.parse(header_template);
	Mustache.parse(issue_template);
	console.log(meta);
	console.log(data);
	var pgRe = /[&?]page\=(\d+)/;
	var linklen = meta.Link.length;
	var thisPage = 0;
	var nextPage = 0;
	for (i=0; i < linklen; i++) {
		if (meta.Link[i][1].rel == "next") {
			nextPage = parseInt(pgRe.exec(meta.Link[i][0])[1]);
		}
		else if (meta.Link[i][1].rel == "last") {
			pagecount = parseInt(pgRe.exec(meta.Link[i][0])[1]);
		}
	}
	if (nextPage > 0) {
		thisPage = nextPage - 1;
	}
	else {
		thisPage = pagecount;
	}
	$('#header_target').html(Mustache.render(header_template, { 'date' : startDate.toISOString() }));
	var odd = false;
	var rendered = Mustache.render(issue_template, {
		'data' : data,
		'bodyf' : function() { return markdown.toHTML(this.body).replace('\n', '<br>'); },
		'userf' : function() { return this.user && this.user.login || '&nbsp;'; },
		'assigneef' : function() { return this.assignee && this.assignee.login || '<i>Not assigned</i>'; },
		'row' : function() { odd = !odd; return odd ? "row-odd" : "row-even"; }
	});
	pages[thisPage-1] = rendered;
	$('#issue_target').html(rendered);
}

function pageUrl(page) {
	return 'https://api.github.com/repos/angular/angular/issues?since=' + startDate.toISOString() + '&callback=render&page=' + String(page);
}

// With the results from the API, display, in HTML, the returned
// values with their title, body, user login, and assignee login.
console.log('pageURL: ' + pageUrl(1));

function renderPage(page) {
	if (pages[page-1]) {
		$('#issue_target').html(pages[page-1]);
	}
	else {
		// This isn't likely to work once head is done loading so I
		// should try having a div that I set the innerHTML to.
		var script = document.createElement('script');
		script.src = pageUrl(page);
		document.getElementsByTagName('head')[0].appendChild(script);
	}
}

// renderPage(1);
var script = document.createElement('script');
script.src = 'js/issues.js';
document.getElementsByTagName('head')[0].appendChild(script);
/*
  To do:
  1) Turn the pager in to a mustache template
  2) Make sure it doesn't add a pager if there is only one page
  3) Make the maximum number of pages shown settable (eg: 5).
  4) Have the active page be the one in the middle of the shown pages
  5) Take in to consideration the "ends" of the pager (eg: Disable
  next page/group when the last page/group is reached.)
  6) Add a refresh button
  7) add a warning when the number of allowed queries gets low.
  8) bonus:  Add oauth login for github to increase allowed queries.
 */
</script>
</head>

<body>
<div class="container-fluid">
<div id="header_target"><h3>Angular Issues</h3></div>
<script id="header_template" type="x-tmpl-mustache">
  <h2>Angular Issues since {{date}}</h2>
</script>
<div class="container" id="issue_top_pager">
  <ul class="pagination">
    <li class="disabled"><a href="#">«</a></li>
    <li class="disabled"><a href="#">&lt;</a></li>
    <li class="active"><a href="javascript:renderPage(1)">1</a></li>
    <li class=""><a href="javascript:renderPage(2)">2</a></li>
    <li><a href="javascript:renderPage(3)">3</a></li>
    <li><a href="javascript:renderPage(4)">4</a></li>
    <li><a href="javascript:renderPage(5)">5</a></li>
    <li><a href="#">6</a></li>
	<li><a href="#">&gt;</a></li>
    <li><a href="#">»</a></li>
  </ul>
</div>
<div class="container-fluid" id="issue_target">Loading...</div>
<script id="issue_template" type="x-tmpl-mustache">
{{#data}}
	<div class="row {{row}}">
	  <div class="col-sm-12"><div class="row"><div class="col-sm-1 custom-text-right"><strong>Title:</strong></div><div class="col-sm-11">{{title}}</div></div></div>
	  <div class="col-sm-12"><div class="row"><div class="col-sm-1 custom-text-right"><strong>User:</strong></div><div class="col-sm-11">{{{userf}}}</div></div></div>
	  <div class="col-sm-12"><div class="row"><div class="col-sm-1 custom-text-right"><strong>Assignee:</strong></div><div class="col-sm-11">{{{assigneef}}}</div></div></div>
	  <div class="col-sm-12"><div class="row"><div class="col-sm-1 custom-text-right"><strong>Issue:</strong></div><div class="col-sm-11">{{{bodyf}}}</div></div></div>
	</div>
{{/data}}
</script>
<div class="container" id="issue_bottom_pager">
  <ul class="pagination">
    <li><a href="#">«</a></li>
    <li><a href="#">1</a></li>
    <li><a href="#">2</a></li>
    <li><a href="#">3</a></li>
    <li><a href="#">4</a></li>
    <li><a href="#">5</a></li>
    <li><a href="#">6</a></li>
    <li><a href="#">»</a></li>
  </ul>
</div>
</div>
</body>
</html>
